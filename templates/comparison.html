<!DOCTYPE html>
<html lang="es">
{% set readonly = readonly | default(False) %}

<head>
    <meta charset="UTF-8">
    <title>JRV {{ jrv }} - Auditoría</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .image-viewer {
            height: 100%;
            overflow: hidden;
            background: #334155;
            position: relative;
        }

        .diff-row {
            background-color: #fee2e2;
            color: #991b1b;
            font-weight: bold;
        }

        .zoomable-img {
            max-width: 100%;
            transition: transform 0.1s ease-out;
            transform-origin: top left;
        }

        .pdf-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            padding: 5px 15px;
            border-radius: 20px;
            display: flex;
            gap: 15px;
            z-index: 50;
            color: white;
        }

        .zoom-btn:hover {
            color: #60a5fa;
            cursor: pointer;
        }

        .editable {
            cursor: text;
            border-bottom: 1px dashed #94a3b8;
            padding: 2px 4px;
        }

        .editable:focus {
            background: #fef08a;
            outline: none;
            border-bottom: 2px solid #ca8a04;
        }

        .status-badge {
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-unverified {
            background: #ffedd5;
            color: #c2410c;
            border: 1px solid #fdba74;
        }

        .status-verified {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <div class="bg-white border-b px-6 py-2 flex justify-between items-center shadow-sm z-20 shrink-0">
        <div class="flex items-center gap-4">
            <a href="{{ '/public/' if readonly else '/' }}" class="text-gray-500 hover:text-black"
                title="Volver al Dashboard"><i class="ph ph-house text-xl"></i></a>

            {% if prev_jrv %}
            <a href="/{{ 'public/' if readonly else '' }}comparison/{{ prev_jrv }}?level={{ level }}"
                class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-lg font-bold text-sm shadow-sm transition-colors flex items-center gap-1">
                <i class="ph ph-caret-left"></i> Anterior
            </a>
            {% else %}
            <button disabled
                class="bg-gray-50 text-gray-300 px-3 py-1.5 rounded-lg font-bold text-sm flex items-center gap-1 cursor-not-allowed">
                <i class="ph ph-caret-left"></i> Anterior
            </button>
            {% endif %}

            <div>
                <h1 class="font-bold text-lg text-slate-800 flex items-center gap-2 ml-2">
                    JRV #{{ jrv }}
                    {% if comp_data.trep.meta and comp_data.trep.meta.estado == 'VALIDADO' %}
                    <span class="status-badge status-verified"><i class="ph ph-check-circle"></i> VALIDADO</span>
                    {% else %}
                    <span class="status-badge status-unverified"><i class="ph ph-warning-circle"></i> PENDIENTE</span>
                    {% endif %}
                </h1>
            </div>
        </div>

        <div class="flex-1 text-center">
            <h1 class="text-lg font-bold text-slate-700 uppercase">FRENAL: Observación Elecciones Generales Honduras
                2025</h1>
        </div>

        <div class="flex gap-2">
            {% if not readonly %}
            <button id="btn-save" onclick="saveChangesUI()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm transition-colors">
                <i class="ph ph-floppy-disk"></i> GUARDAR
            </button>
            <button id="btn-validate" onclick="validateAndNext()"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-1.5 rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm transition-colors">
                VALIDAR Y SIGUIENTE <i class="ph ph-caret-right text-lg"></i>
            </button>
            {% endif %}

            {% if next_jrv %}
            <a href="/{{ 'public/' if readonly else '' }}comparison/{{ next_jrv }}?level={{ level }}"
                class="{{ 'bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-lg font-bold text-sm shadow-sm transition-colors flex items-center gap-1' if readonly else 'text-gray-400 hover:text-gray-600 px-2 flex items-center' }}"
                title="Siguiente">
                {% if readonly %}Siguiente{% endif %} <i class="ph ph-caret-right text-xl"></i>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Layout 3 Columnas -->
    <!-- Layout Principal -->
    <div class="flex flex-col flex-1 overflow-hidden">

        <!-- Formulario Cierre Info -->
        {% if comp_data and comp_data.header_info %}
        <div
            class="bg-indigo-900/50 border-b border-indigo-700 p-3 text-xs text-indigo-100 flex flex-wrap gap-4 items-center justify-center shrink-0">
            <div class="flex items-center gap-1">
                <i class="ph ph-user font-bold text-indigo-300"></i>
                <span class="font-bold">Observador:</span> {{ comp_data.header_info.observador }}
            </div>
            <div class="flex items-center gap-1">
                <i class="ph ph-map-pin font-bold text-indigo-300"></i>
                <span class="font-bold">Ubicación:</span>
                {{ comp_data.header_info.depto}} - {{ comp_data.header_info.muni}}
            </div>
            <div class="flex items-center gap-1">
                <i class="ph ph-buildings font-bold text-indigo-300"></i>
                <span class="font-bold">Centro:</span> {{ comp_data.header_info.centro }}
            </div>
            {% if comp_data.header_info.votantes_registro %}
            <div class="flex items-center gap-1 bg-indigo-800 px-2 py-0.5 rounded-full border border-indigo-600">
                <i class="ph ph-users font-bold text-cyan-400"></i>
                <span class="font-bold text-indigo-200">Votantes Reg.:</span>
                <span class="font-bold text-white">{{ comp_data.header_info.votantes_registro }}</span>
            </div>
            {% endif %}

            {% if comp_data.header_info.participacion %}
            <div class="flex items-center gap-1 bg-indigo-800 px-2 py-0.5 rounded-full border border-indigo-600">
                <i class="ph ph-chart-pie-slice font-bold text-emerald-400"></i>
                <span class="font-bold text-indigo-200">Participación:</span>
                <span class="font-bold text-white">{{ comp_data.header_info.participacion }}</span>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Level Selector -->
        <div class="bg-slate-900 p-4 flex justify-center space-x-4 shrink-0">
            {% for l in ['PRESIDENTE', 'DIPUTADOS', 'ALCALDE'] %}
            <a href="{{ url_for('public_comparison' if readonly else 'comparison', jrv=jrv, level=l) }}"
                class="px-4 py-2 rounded-lg font-bold {{ 'bg-blue-600 text-white' if level == l else 'bg-slate-700 text-slate-300 hover:bg-slate-600' }}">
                {{ l }}
            </a>
            {% endfor %}
        </div>

        <!-- Main Content: 3 Columns -->
        <div class="flex-1 flex overflow-hidden">

            <!-- Left Column: FRENAEL Image -->
            <div class="w-1/3 bg-black flex flex-col border-r border-slate-700 relative group">
                <div class="absolute top-2 left-2 z-10 bg-black/70 text-white text-xs px-2 py-1 rounded">
                    FRENAEL ({{ level }})
                </div>

                <!-- Hidden Input -->
                <input type="file" id="file-trep" class="hidden" accept="image/*" onchange="uploadActa('TREP')">

                <div class="image-viewer flex-1 relative w-full h-full overflow-hidden flex justify-center items-center bg-gray-900"
                    id="viewer-trep">
                    {% if comp_data.has_trep and comp_data.trep.meta and comp_data.trep.meta.filepath %}
                    <img src="/{{ comp_data.trep.meta.filepath }}"
                        class="zoomable-img max-w-full max-h-full object-contain transition-transform duration-200 ease-out origin-center"
                        id="img-trep" alt="Acta FRENAEL">
                    {% else %}
                    <div class="flex items-center justify-center h-full text-slate-500 flex-col gap-4">
                        <i class="ph ph-image-slash text-4xl mb-2"></i>
                        <p class="text-lg font-bold">{% if comp_data.has_trep == False %}SIN ACTA{% else %}No Image{%
                            endif %}</p>
                        {% if not readonly %}
                        <button onclick="triggerUpload('TREP')"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full flex items-center gap-2 transition-transform hover:scale-105 shadow-lg z-30 pointer-events-auto">
                            <i class="ph ph-upload-simple font-bold"></i>
                            Subir Acta
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if comp_data.has_trep == False %}
                    <div class="absolute inset-0 flex items-center justify-center bg-black/50 pointer-events-none">
                        <span
                            class="text-red-500 font-bold text-3xl opacity-50 -rotate-12 border-4 border-red-500 p-4 rounded">SIN
                            ACTA</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Controls -->
                <div
                    class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2 text-white bg-black/60 px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-50">
                    <button onclick="rotate('img-trep', -90)" title="Rotar Izquierda" class="hover:text-blue-400"><i
                            class="ph ph-arrow-counter-clockwise"></i></button>
                    <button onclick="changeZoom('img-trep', -0.5)" title="Alejar" class="hover:text-blue-400"><i
                            class="ph ph-minus-circle"></i></button>
                    <button onclick="resetZoom('img-trep')" title="Reset" class="hover:text-blue-400"><i
                            class="ph ph-arrows-out"></i></button>
                    <button onclick="changeZoom('img-trep', 0.5)" title="Acercar" class="hover:text-blue-400"><i
                            class="ph ph-plus-circle"></i></button>
                    <button onclick="rotate('img-trep', 90)" title="Rotar Derecha" class="hover:text-blue-400"><i
                            class="ph ph-arrow-clockwise"></i></button>

                    {% if not readonly %}
                    <div class="w-px bg-gray-500 mx-1"></div>
                    <button onclick="saveRotation('TREP')" title="Guardar Rotación"
                        class="text-blue-400 hover:text-blue-300"><i class="ph ph-floppy-disk"></i></button>

                    <div class="w-px bg-gray-500 mx-2"></div>

                    <button onclick="triggerUpload('TREP')" title="Reemplazar Imagen" class="hover:text-yellow-400"><i
                            class="ph ph-swap"></i></button>
                    {% if comp_data.has_trep %}
                    <button onclick="deleteActa('TREP')" title="Eliminar Acta" class="hover:text-red-500"><i
                            class="ph ph-trash"></i></button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Center Column: Unified Data Table -->
            <div class="flex-1 bg-slate-900 border-x border-slate-700 flex flex-col min-w-[400px]">

                <!-- Table Header -->
                <div
                    class="bg-indigo-900 text-white p-2 text-sm font-bold shadow-md z-10 flex justify-between items-center">
                    <div class="flex flex-col">
                        <span>COMPARATIVA DE VOTOS</span>
                        {% if comp_data.has_trep == False %}
                        <span class="text-[10px] text-red-300 bg-red-900/50 px-1 rounded mt-0.5 animate-pulse">⚠ SIN
                            ACTA EN FRENAEL</span>
                        {% endif %}
                    </div>

                    <!-- Bulk Actions -->
                    {% if not readonly %}
                    <div class="flex items-center space-x-2">
                        <span
                            class="text-[10px] text-indigo-300 uppercase tracking-wider font-bold hidden md:inline">Copiar:</span>
                        <div class="flex items-center bg-indigo-800 rounded border border-indigo-600 shadow-sm">
                            <button onclick="copyAll('OFICIAL', 'TREP')"
                                class="px-3 py-1 hover:bg-indigo-600 rounded-l flex items-center gap-1 text-xs text-blue-200 transition-colors border-r border-indigo-700"
                                title="Copiar OFICIAL a FRENAEL">
                                <span class="font-bold">O</span> <i class="ph ph-arrow-right"></i> <span
                                    class="font-bold">F</span>
                            </button>
                            <button onclick="copyAll('TREP', 'OFICIAL')"
                                class="px-3 py-1 hover:bg-indigo-600 rounded-r flex items-center gap-1 text-xs text-emerald-200 transition-colors"
                                title="Copiar FRENAEL a OFICIAL">
                                <span class="font-bold">F</span> <i class="ph ph-arrow-right"></i> <span
                                    class="font-bold">O</span>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- LIST VIEW (Presidente / Alcalde) -->
                {% if level != 'DIPUTADOS' %}
                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-3 py-2 rounded-tl-lg">Candidato</th>
                                <th class="px-3 py-2 text-right bg-blue-900/30 text-blue-200">
                                    FRENAEL
                                </th>
                                <th class="px-3 py-2 text-right bg-emerald-900/30 text-emerald-200">
                                    OFICIAL
                                </th>
                                <th class="px-3 py-2 text-center rounded-tr-lg">Diff</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            {% for cand in comp_data.all_candidates %}
                            {% set v_trep = comp_data.trep.votos.get(cand, 0) %}
                            {% set v_esc = comp_data.esc.votos.get(cand, 0) %}
                            {% set diff = (v_esc - v_trep) %}

                            <tr class="hover:bg-slate-800 transition-colors data-row group">
                                <td class="px-3 py-2 font-medium text-white truncate max-w-[180px]" title="{{ cand }}">
                                    {{ cand }}</td>
                                <td class="px-3 py-2 text-right bg-blue-900/10 group-hover:bg-blue-900/20">
                                    <span class="trep-value hidden">{{ v_trep }}</span>
                                    <input type="number" value="{{ v_trep }}" data-type="vote" data-key="{{ cand }}"
                                        data-source="TREP" {% if readonly %}disabled{% endif %}
                                        class="editable w-20 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-right focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none text-white font-mono"
                                        onkeydown="moveFocus(event, this)" oninput="markDirty()">
                                </td>
                                <td class="px-3 py-2 text-right bg-emerald-900/10 group-hover:bg-emerald-900/20">
                                    <span class="esc-value hidden" data-val="{{ v_esc }}"></span>
                                    <input type="number" value="{{ v_esc }}" data-type="vote" data-key="{{ cand }}"
                                        data-source="OFICIAL" {% if readonly %}disabled{% endif %}
                                        class="editable w-20 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-right focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 focus:outline-none text-white font-mono"
                                        onkeydown="moveFocus(event, this)" oninput="markDirty()">
                                </td>
                                <td class="px-3 py-2 text-center diff-cell font-bold text-xs">{{ diff }}</td>
                            </tr>
                            {% endfor %}

                            <!-- Summaries -->
                            <!-- Summaries -->
                            {% for key, label in {'votos_blancos': 'BLANCOS', 'votos_nulos': 'NULOS', 'gran_total':
                            'TOTAL'}.items() %}
                            {% set t_val = comp_data.trep.resumen[key] %}
                            {% set e_val = comp_data.esc.resumen[key] %}
                            <tr class="bg-slate-800/50 font-bold border-t border-slate-600 data-row summary-row"
                                data-key="{{ key }}">
                                <td class="px-3 py-2 text-slate-400 text-xs">{{ label }}</td>
                                <td class="px-3 py-2 text-right text-slate-300">
                                    {% if key == 'gran_total' %}
                                    <span id="summary-trep-total" class="font-mono text-blue-300">{{ t_val }}</span>
                                    {% else %}
                                    <input type="number" value="{{ t_val }}" data-type="resumen" data-key="{{ key }}"
                                        data-source="TREP" {% if readonly %}disabled{% endif %}
                                        class="editable w-20 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-right text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none text-white font-mono"
                                        onkeydown="moveFocus(event, this)" oninput="markDirty()"
                                        onchange="updateValue('{{ key }}', 'TREP', this.value, true)">
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-right text-slate-300">
                                    {% if key == 'gran_total' %}
                                    <span id="summary-esc-total" class="font-mono text-emerald-300">{{ e_val }}</span>
                                    {% else %}
                                    <input type="number" value="{{ e_val }}" data-type="resumen" data-key="{{ key }}"
                                        data-source="OFICIAL" {% if readonly %}disabled{% endif %}
                                        class="editable w-20 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-right text-xs focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 focus:outline-none text-white font-mono"
                                        onkeydown="moveFocus(event, this)" oninput="markDirty()"
                                        onchange="updateValue('{{ key }}', 'OFICIAL', this.value, true)">
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-center text-xs diff-cell">{{ e_val - t_val }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <!-- MATRIX VIEW FOR DIPUTADOS -->
                {% if level == 'DIPUTADOS' and comp_data.matrix %}
                <div class="flex-1 overflow-auto p-4 custom-scrollbar">
                    <div class="overflow-visible shadow-md rounded-lg inline-block min-w-full">
                        <table class="border-collapse border border-gray-300 text-sm bg-white table-auto">
                            <thead class="sticky top-0 z-20 shadow-md">
                                <tr>
                                    <th class="border border-gray-300 bg-gray-100 p-1 w-8 text-center text-gray-500">#
                                    </th>
                                    {% for party in comp_data.matrix.parties %}
                                    {% set party_styles = {
                                    'NACIONAL': 'bg-blue-700 text-white',
                                    'LIBERAL': 'bg-red-600 text-white',
                                    'LIBRE': 'bg-red-800 text-white',
                                    'DC': 'bg-green-600 text-white',
                                    'PINU': 'bg-orange-500 text-white',
                                    'PSH': 'bg-cyan-600 text-white',
                                    'PN': 'bg-blue-700 text-white',
                                    'PL': 'bg-red-600 text-white'
                                    } %}
                                    {% set bg_class = party_styles.get(party, 'bg-gray-700 text-white') %}
                                    <th
                                        class="border border-gray-300 {{ bg_class }} p-1 min-w-[85px] text-center uppercase tracking-wider text-[10px]">
                                        <div class="flex flex-col items-center gap-0.5"><span>{{ party }}</span></div>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in comp_data.matrix.rows %}
                                <tr class="hover:bg-gray-50">
                                    <td
                                        class="border border-gray-300 p-1 font-bold text-center bg-gray-100 text-gray-600 text-[10px]">
                                        {{ i }}</td>
                                    {% for party in comp_data.matrix.parties %}
                                    {% set key = comp_data.matrix.map[party][i] %}
                                    <td
                                        class="border border-gray-300 p-0.5 align-middle text-center h-10 relative min-w-[85px]">
                                        {% if key %}
                                        {% set val_trep = comp_data.trep.votos.get(key, 0) %}
                                        {% set val_esc = comp_data.esc.votos.get(key, 0) %}

                                        <div class="flex flex-col gap-0.5 justify-center items-stretch h-full w-full"
                                            id="row-{{ key|replace(' ', '-') }}">

                                            <!-- Candidate Name -->
                                            {% set cand_name = comp_data.matrix.names.get(party, {}).get(i, '') %}
                                            <div class="text-[8px] text-center font-bold text-gray-600 leading-tight bg-gray-50 border-b border-gray-200 p-0.5 truncate"
                                                title="{{ cand_name }}">
                                                {{ cand_name }}
                                            </div>

                                            <div class="flex gap-0.5 h-full">

                                                <!-- F (FRENAEL) -->
                                                <div
                                                    class="flex-1 flex flex-col justify-center border border-blue-300 bg-blue-50 rounded text-center relative p-0.5">
                                                    <!-- <span class="text-[6px] text-blue-600 font-bold leading-none mb-0.5">F</span> -->
                                                    <input type="number" {% if readonly %}disabled{% endif %}
                                                        class="editable w-full bg-transparent text-center font-mono text-xs font-bold outline-none p-0 focus:ring-0 border-none appearance-none text-blue-800 leading-tight"
                                                        value="{{ val_trep }}" data-type="vote" data-key="{{ key }}"
                                                        data-source="TREP" onfocus="this.select()"
                                                        onchange="updateValue('{{ key }}', 'TREP', this.value)"
                                                        title="Frenael">
                                                </div>

                                                <!-- O (OFICIAL) -->
                                                <div
                                                    class="flex-1 flex flex-col justify-center border rounded text-center relative p-0.5
                                                        {% if val_trep != val_esc %}border-red-300 bg-red-50{% else %}border-emerald-200 bg-emerald-50{% endif %}">
                                                    <!-- <span class="text-[6px] font-bold leading-none mb-0.5 {% if val_trep != val_esc %}text-red-500{% else %}text-emerald-500{% endif %}">O</span> -->
                                                    <input type="number" {% if readonly %}disabled{% endif %}
                                                        class="editable w-full bg-transparent text-center font-mono text-xs font-bold outline-none p-0 focus:ring-0 border-none appearance-none leading-tight
                                                            {% if val_trep != val_esc %}text-red-700{% else %}text-emerald-700{% endif %}" value="{{ val_esc }}"
                                                        data-type="vote" data-key="{{ key }}" data-source="OFICIAL"
                                                        onfocus="this.select()"
                                                        onchange="updateValue('{{ key }}', 'ESCRUTINIO', this.value)"
                                                        title="Oficial">
                                                </div>
                                            </div>
                                            {% else %}
                                            <div
                                                class="bg-gray-50 h-full w-full flex items-center justify-center text-gray-300">
                                                <i class="ph ph-prohibit text-sm"></i>
                                            </div>
                                            {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <!-- TOTALS ROW -->
                                <tr class="bg-gray-100 font-bold border-t-2 border-gray-400">
                                    <td class="p-2 text-center text-gray-700 text-xs">TOTAL</td>
                                    {% for party in comp_data.matrix.parties %}
                                    {% set totals = comp_data.matrix.totals[party] %}
                                    <td class="p-1 border border-gray-300">
                                        <div class="flex gap-1 justify-center items-stretch h-full w-full">
                                            <!-- F Total -->
                                            <div
                                                class="flex-1 flex flex-col justify-center border border-blue-300 bg-blue-50 rounded text-center p-0.5">
                                                <span class="text-xs font-mono font-bold text-blue-900">{{ totals.trep
                                                    }}</span>
                                            </div>
                                            <!-- O Total -->
                                            <div
                                                class="flex-1 flex flex-col justify-center border border-gray-300 bg-gray-50 rounded text-center p-0.5">
                                                <span class="text-xs font-mono font-bold text-gray-900">{{ totals.esc
                                                    }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                <!-- DIFFERENCE ROW -->
                                <tr class="bg-gray-200 font-bold border-t border-gray-300">
                                    <td class="p-2 text-center text-gray-700 text-[10px] uppercase leading-tight">
                                        DIFERENCIA<br>(F - O)</td>
                                    {% for party in comp_data.matrix.parties %}
                                    {% set diff = comp_data.matrix.totals[party].diff %}
                                    <td class="p-1 border border-gray-300 text-center">
                                        <div class="w-full flex items-center justify-center font-mono text-xs font-bold
                                            {% if diff == 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
                                            {{ diff }}
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                <!-- INLINE GLOBAL SUMMARY -->
                                {% if level == 'DIPUTADOS' %}
                                {% set col_span = comp_data.matrix.parties|length + 1 %}

                                <!-- Total Marcas -->
                                <tr class="bg-gray-50 border-t border-gray-300">
                                    <td colspan="{{ col_span }}" class="p-2">
                                        <div class="flex items-center justify-end gap-3 pr-2">
                                            <span class="font-bold text-gray-600 text-xs uppercase">TOTAL MARCAS:</span>
                                            <div id="matrix-total-trep"
                                                class="w-20 text-center font-mono font-bold text-blue-900 bg-blue-50 border border-blue-200 rounded px-2 py-1 text-xs">
                                                {{ comp_data.trep.total_marcas }}
                                            </div>
                                            <div id="matrix-total-esc"
                                                class="w-20 text-center font-mono font-bold text-emerald-900 bg-emerald-50 border border-emerald-200 rounded px-2 py-1 text-xs">
                                                {{ comp_data.esc.total_marcas }}
                                            </div>
                                            <div id="matrix-diff-total"
                                                class="w-12 text-center text-xs font-bold diff-cell">
                                                {{ comp_data.esc.total_marcas - comp_data.trep.total_marcas }}
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Papeletas Validas -->
                                <tr class="bg-white border-t border-gray-200 summary-row" data-key="votos_validos">
                                    <td colspan="{{ col_span }}" class="p-2">
                                        <div class="flex items-center justify-end gap-3 pr-2">
                                            <span class="font-bold text-gray-600 text-xs uppercase">PAPELETAS
                                                VALIDAS:</span>

                                            <!-- TREP -->
                                            <input type="number" {% if readonly %}disabled{% endif %}
                                                class="editable w-20 bg-white border border-blue-300 rounded px-2 py-1 text-center text-xs font-mono font-bold text-blue-800 focus:ring-1 focus:ring-blue-500 outline-none"
                                                value="{{ comp_data.trep.resumen.votos_validos }}" data-type="resumen"
                                                data-key="votos_validos" data-source="TREP" onfocus="this.select()"
                                                onchange="updateValue('votos_validos', 'TREP', this.value, true)">

                                            <!-- OFICIAL -->
                                            <input type="number" {% if readonly %}disabled{% endif %}
                                                class="editable w-20 bg-white border border-emerald-300 rounded px-2 py-1 text-center text-xs font-mono font-bold text-emerald-800 focus:ring-1 focus:ring-emerald-500 outline-none"
                                                value="{{ comp_data.esc.resumen.votos_validos }}" data-type="resumen"
                                                data-key="votos_validos" data-source="OFICIAL" onfocus="this.select()"
                                                onchange="updateValue('votos_validos', 'OFICIAL', this.value, true)"
                                                title="Oficial">

                                            <!-- Diff -->
                                            <div class="w-12 text-center font-bold text-xs diff-cell">
                                                {{ comp_data.esc.resumen.votos_validos -
                                                comp_data.trep.resumen.votos_validos }}
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Votos Blancos -->
                                <tr class="bg-white border-t border-gray-200 summary-row" data-key="votos_blancos">
                                    <td colspan="{{ col_span }}" class="p-2">
                                        <div class="flex items-center justify-end gap-3 pr-2">
                                            <span class="font-bold text-gray-600 text-xs uppercase">PAPELETAS
                                                BLANCAS:</span>

                                            <!-- TREP -->
                                            <input type="number" {% if readonly %}disabled{% endif %}
                                                class="editable w-20 bg-white border border-blue-300 rounded px-2 py-1 text-center text-xs font-mono font-bold text-blue-800 focus:ring-1 focus:ring-blue-500 outline-none"
                                                value="{{ comp_data.trep.resumen.votos_blancos }}" data-type="resumen"
                                                data-key="votos_blancos" data-source="TREP" onfocus="this.select()"
                                                onchange="updateValue('votos_blancos', 'TREP', this.value, true)">

                                            <!-- OFICIAL -->
                                            <input type="number" {% if readonly %}disabled{% endif %}
                                                class="editable w-20 bg-white border border-emerald-300 rounded px-2 py-1 text-center text-xs font-mono font-bold text-emerald-800 focus:ring-1 focus:ring-emerald-500 outline-none"
                                                value="{{ comp_data.esc.resumen.votos_blancos }}" data-type="resumen"
                                                data-key="votos_blancos" data-source="OFICIAL" onfocus="this.select()"
                                                onchange="updateValue('votos_blancos', 'OFICIAL', this.value, true)"
                                                title="Oficial">

                                            <!-- Diff -->
                                            <div class="w-12 text-center font-bold text-xs diff-cell">
                                                {{ comp_data.esc.resumen.votos_blancos -
                                                comp_data.trep.resumen.votos_blancos }}
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Votos Nulos -->
                                <tr class="bg-white border-t border-gray-200 summary-row" data-key="votos_nulos">
                                    <td colspan="{{ col_span }}" class="p-2">
                                        <div class="flex items-center justify-end gap-3 pr-2">
                                            <span class="font-bold text-gray-600 text-xs uppercase">PAPELETAS
                                                NULAS:</span>

                                            <!-- TREP -->
                                            <input type="number" {% if readonly %}disabled{% endif %}
                                                class="editable w-20 bg-white border border-blue-300 rounded px-2 py-1 text-center text-xs font-mono font-bold text-blue-800 focus:ring-1 focus:ring-blue-500 outline-none"
                                                value="{{ comp_data.trep.resumen.votos_nulos }}" data-type="resumen"
                                                data-key="votos_nulos" data-source="TREP" onfocus="this.select()"
                                                onchange="updateValue('votos_nulos', 'TREP', this.value, true)">

                                            <!-- OFICIAL -->
                                            <input type="number" {% if readonly %}disabled{% endif %}
                                                class="editable w-20 bg-white border border-emerald-300 rounded px-2 py-1 text-center text-xs font-mono font-bold text-emerald-800 focus:ring-1 focus:ring-emerald-500 outline-none"
                                                value="{{ comp_data.esc.resumen.votos_nulos }}" data-type="resumen"
                                                data-key="votos_nulos" data-source="OFICIAL" onfocus="this.select()"
                                                onchange="updateValue('votos_nulos', 'OFICIAL', this.value, true)"
                                                title="Oficial">

                                            <!-- Diff -->
                                            <div class="w-12 text-center font-bold text-xs diff-cell">
                                                {{ comp_data.esc.resumen.votos_nulos -
                                                comp_data.trep.resumen.votos_nulos }}
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Gran Total -->
                                <tr class="bg-gray-100 border-t-2 border-gray-400 font-bold summary-row"
                                    data-key="gran_total">
                                    <td colspan="{{ col_span }}" class="p-2">
                                        <div class="flex items-center justify-end gap-3 pr-2 text-sm">
                                            <span class="text-gray-800 uppercase">TOTAL:</span>
                                            <div class="w-20 text-center text-blue-900" id="summary-total-trep">0</div>
                                            <div class="w-20 text-center text-emerald-900" id="summary-total-esc">0
                                            </div>
                                            <div class="w-12 text-center diff-cell">0</div>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tfoot>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- GLOBAL SUMMARY REMOVED (Moving to Table Footer) -->

                <!-- Summary Footer -->
                <div
                    class="bg-slate-800 p-3 flex justify-between items-center text-xs border-t border-slate-700 flex-shrink-0">
                    <div class="flex space-x-4">
                        <div class="text-slate-400">Total Validado: <span id="total-trep"
                                class="text-white font-bold">-</span></div>
                        <div class="text-slate-400">Total Oficial: <span id="total-esc"
                                class="text-white font-bold">-</span></div>
                    </div>
                    <div id="save-status" class="text-slate-500 italic">Todo guardado</div>
                </div>

            </div>

            <!-- Right Column: OFICIAL Image -->
            <div class="w-1/3 bg-black flex flex-col border-l border-slate-700 relative group">
                <div class="absolute top-2 right-2 z-10 bg-emerald-900/80 text-white text-xs px-2 py-1 rounded">
                    OFICIAL ({{ level }})
                </div>

                <!-- Hidden Input -->
                <input type="file" id="file-esc" class="hidden" accept="image/*" onchange="uploadActa('OFICIAL')">

                <div class="image-viewer flex-1 relative w-full h-full overflow-hidden flex justify-center items-center bg-gray-900"
                    id="viewer-esc">
                    {% if comp_data.esc.meta and comp_data.esc.meta.filepath %}
                    <img src="/{{ comp_data.esc.meta.filepath }}"
                        class="zoomable-img max-w-full max-h-full object-contain transition-transform duration-200 ease-out origin-center"
                        id="img-esc" alt="Acta OFICIAL">
                    {% else %}
                    <div class="flex items-center justify-center h-full text-slate-500 flex-col gap-4">
                        <i class="ph ph-image-slash text-4xl mb-2"></i>
                        <p class="text-lg font-bold">{% if comp_data.has_trep == False %}SIN ACTA{% else %}No Image{%
                            endif %}</p>
                        {% if not readonly %}
                        <button onclick="triggerUpload('OFICIAL')"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full flex items-center gap-2 transition-transform hover:scale-105 shadow-lg z-30 pointer-events-auto">
                            <i class="ph ph-upload-simple font-bold"></i>
                            Subir Acta
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if comp_data.has_trep == False %}
                    <div class="absolute inset-0 flex items-center justify-center bg-black/50 pointer-events-none z-20">
                        <span
                            class="text-red-500 font-bold text-3xl opacity-80 -rotate-12 border-4 border-red-500 p-4 rounded bg-black/50">SIN
                            ACTA</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Controls -->
                <div
                    class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2 text-white bg-black/60 px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-50">
                    <button onclick="rotate('img-esc', -90)" title="Rotar Izquierda" class="hover:text-emerald-400"><i
                            class="ph ph-arrow-counter-clockwise"></i></button>
                    <button onclick="changeZoom('img-esc', -0.5)" title="Alejar" class="hover:text-emerald-400"><i
                            class="ph ph-minus-circle"></i></button>
                    <button onclick="resetZoom('img-esc')" title="Reset" class="hover:text-emerald-400"><i
                            class="ph ph-arrows-out"></i></button>
                    <button onclick="changeZoom('img-esc', 0.5)" title="Acercar" class="hover:text-emerald-400"><i
                            class="ph ph-plus-circle"></i></button>
                    <button onclick="rotate('img-esc', 90)" title="Rotar Derecha" class="hover:text-emerald-400"><i
                            class="ph ph-arrow-clockwise"></i></button>

                    {% if not readonly %}
                    <div class="w-px bg-gray-500 mx-1"></div>
                    <button onclick="saveRotation('OFICIAL')" title="Guardar Rotación"
                        class="text-blue-400 hover:text-blue-300"><i class="ph ph-floppy-disk"></i></button>

                    <div class="w-px bg-gray-500 mx-2"></div>

                    <button onclick="triggerUpload('OFICIAL')" title="Reemplazar Imagen"
                        class="hover:text-yellow-400"><i class="ph ph-swap"></i></button>
                    {% if comp_data.esc.meta and comp_data.esc.meta.id %}
                    <button onclick="deleteActa('OFICIAL')" title="Eliminar Acta" class="hover:text-red-500"><i
                            class="ph ph-trash"></i></button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

    </div>

    <script>
        const ID_TREP = {{ comp_data.trep.meta.id if comp_data.trep and comp_data.trep.meta and comp_data.trep.meta.id else 0 }};
        const ID_ESC = {{ comp_data.esc.meta.id if comp_data.esc and comp_data.esc.meta and comp_data.esc.meta.id else 0 }};
        console.log("Debug IDs - TREP:", ID_TREP, "ESC:", ID_ESC);

        let hasUnsavedChanges = false;

        // Init Rotation
        let initialRotationEsc = 0;
        let initialRotationTrep = 0;
        try {
            {% if comp_data.esc and comp_data.esc.meta and comp_data.esc.meta.debug_data %}
            const debugStrEsc = {{ comp_data.esc.meta.debug_data | tojson
        }};
        const debugObjEsc = JSON.parse(debugStrEsc);
        if (debugObjEsc.rotation) initialRotationEsc = parseInt(debugObjEsc.rotation) || 0;
        {% endif %}

        {% if comp_data.trep and comp_data.trep.meta and comp_data.trep.meta.debug_data %}
        const debugStrTrep = {{ comp_data.trep.meta.debug_data | tojson }};
        const debugObjTrep = JSON.parse(debugStrTrep);
        if (debugObjTrep.rotation) initialRotationTrep = parseInt(debugObjTrep.rotation) || 0;
        {% endif %}
        } catch (e) {
            console.error("Error parsing debug_data:", e);
        }

        // Apply initial rotation on load
        window.addEventListener('DOMContentLoaded', () => {
            if (initialRotationEsc !== 0) {
                const img = document.getElementById('img-esc');
                if (img) {
                    const s = getTransformState(img);
                    s.rotate = initialRotationEsc;
                    updateTransform(img, s);
                }
            }
            if (initialRotationTrep !== 0) {
                const img = document.getElementById('img-trep');
                if (img) {
                    const s = getTransformState(img);
                    s.rotate = initialRotationTrep;
                    updateTransform(img, s);
                }
            }
        });

        function updateMatrixTotals() {
            const table = document.querySelector('table.border-collapse');
            if (!table) return;
            const headerRow = table.querySelector('thead tr');
            if (!headerRow) return;
            const cols = headerRow.querySelectorAll('th');
            if (cols.length < 2) return;

            // Iterate Party Columns (index 1 to N)
            for (let i = 1; i < cols.length; i++) {
                let sumTrep = 0;
                let sumEsc = 0;

                // Sum inputs in this column
                const cells = table.querySelectorAll(`tbody tr td:nth-child(${i + 1})`);
                cells.forEach(cell => {
                    const inpTrep = cell.querySelector('input[data-source="TREP"]');
                    const inpEsc = cell.querySelector('input[data-source="OFICIAL"]');
                    if (inpTrep) sumTrep += (parseInt(inpTrep.value) || 0);
                    if (inpEsc) sumEsc += (parseInt(inpEsc.value) || 0);
                });

                // Update Footer Totals
                // Row 1: Totals
                const footerRow = table.querySelector('tfoot tr:first-child');
                if (footerRow) {
                    const cell = footerRow.querySelector(`td:nth-child(${i + 1})`);
                    if (cell) {
                        const sT = cell.querySelector('.text-blue-900');
                        const sE = cell.querySelector('.text-gray-900');
                        if (sT) sT.innerText = sumTrep;
                        if (sE) sE.innerText = sumEsc;
                    }
                }

                // Row 2: Diff
                const diffRow = table.querySelector('tfoot tr:nth-child(2)');
                if (diffRow) {
                    const cell = diffRow.querySelector(`td:nth-child(${i + 1})`);
                    if (cell) {
                        const div = cell.querySelector('div');
                        if (div) {
                            const d = sumEsc - sumTrep;
                            div.innerText = d;
                            div.className = `w-full flex items-center justify-center font-mono text-xs font-bold ${d === 0 ? 'text-emerald-600' : 'text-red-600'}`;
                        }
                    }
                }
            }
        }

        function updateCalculations() {
            let totalTrep = 0;
            let totalEsc = 0;

            // 1. Sum Candidates
            document.querySelectorAll('tbody tr').forEach(row => {
                if (row.classList.contains('summary-row')) return;
                const inputs = row.querySelectorAll('input[data-type="vote"]');
                inputs.forEach(inp => {
                    if (inp.dataset.source === 'TREP') totalTrep += (parseInt(inp.value) || 0);
                    if (inp.dataset.source === 'OFICIAL' || inp.dataset.source === 'ESCRUTINIO') totalEsc += (parseInt(inp.value) || 0);
                });

                // Row Diff (List View)
                const diffCell = row.querySelector('.diff-cell');
                if (diffCell) {
                    let rT = 0, rE = 0;
                    const iT = row.querySelector('input[data-source="TREP"]');
                    const iE = row.querySelector('input[data-source="OFICIAL"]');
                    if (iT) rT = parseInt(iT.value) || 0;
                    if (iE) rE = parseInt(iE.value) || 0;
                    const d = rE - rT;
                    if (d !== 0) diffCell.innerHTML = `<span class="text-red-400 bg-red-900/50 px-1.5 py-0.5 rounded font-bold">${d > 0 ? '+' + d : d}</span>`;
                    else diffCell.innerHTML = `<i class="ph ph-check text-green-500"></i>`;
                }
            });

            // Update Matrix Columns
            updateMatrixTotals();

            // Update Matrix Grand Total (Total Marcas)
            const mTT = document.getElementById('matrix-total-trep');
            const mTE = document.getElementById('matrix-total-esc');
            const mTD = document.getElementById('matrix-diff-total');
            if (mTT) mTT.innerText = totalTrep;
            if (mTE) mTE.innerText = totalEsc;
            if (mTD) {
                const d = totalEsc - totalTrep;
                mTD.innerText = d;
                // mTD.className = ... (optional, it triggers css)
            }

            // 2. Update Header Totals (Candidates Only, List View)
            const fT = document.getElementById('total-trep');
            const fE = document.getElementById('total-esc');
            if (fT) fT.innerText = totalTrep.toLocaleString();
            if (fE) fE.innerText = totalEsc.toLocaleString();

            // 3. Update Gran Total
            // IF DIPUTADOS: Gran Total = Papeletas Validas (Editable) + Blancos + Nulos
            // IF OTHERS: Gran Total = Total Marcas (Sum of Candidates) + Blancos + Nulos

            const isDiputados = document.querySelector('input[data-key="votos_validos"]'); // Detection check

            const getVal = (key, source) => {
                const el = document.querySelector(`input[data-type="resumen"][data-key="${key}"][data-source="${source}"]`);
                return el ? (parseInt(el.value) || 0) : 0;
            };

            let granTotalTrep = 0;
            let granTotalEsc = 0;

            if (isDiputados) {
                const validosTrep = getVal('votos_validos', 'TREP');
                const validosEsc = getVal('votos_validos', 'OFICIAL');

                const blancosTrep = getVal('votos_blancos', 'TREP');
                const nulosTrep = getVal('votos_nulos', 'TREP');
                const blancosEsc = getVal('votos_blancos', 'OFICIAL');
                const nulosEsc = getVal('votos_nulos', 'OFICIAL');

                granTotalTrep = validosTrep + blancosTrep + nulosTrep;
                granTotalEsc = validosEsc + blancosEsc + nulosEsc;

                const elTotalTrep = document.getElementById('summary-total-trep');
                const elTotalEsc = document.getElementById('summary-total-esc');
                if (elTotalTrep) elTotalTrep.innerText = granTotalTrep.toLocaleString();
                if (elTotalEsc) elTotalEsc.innerText = granTotalEsc.toLocaleString();

                // Update Diff for Grand Total
                const gtRow = document.querySelector('tr[data-key="gran_total"]');
                if (gtRow) {
                    const diffCell = gtRow.querySelector('.diff-cell');
                    if (diffCell) diffCell.innerText = (granTotalEsc - granTotalTrep).toLocaleString();
                }

            } else {
                // PRESIDENTE / ALCALDE Logic (Sum of Candidates is Validos)
                const blancosTrep = getVal('votos_blancos', 'TREP');
                const nulosTrep = getVal('votos_nulos', 'TREP');
                const blancosEsc = getVal('votos_blancos', 'OFICIAL');
                const nulosEsc = getVal('votos_nulos', 'OFICIAL');

                granTotalTrep = totalTrep + blancosTrep + nulosTrep;
                granTotalEsc = totalEsc + blancosEsc + nulosEsc;

                const elTotalTrep = document.getElementById('summary-total-trep');
                const elTotalEsc = document.getElementById('summary-total-esc');
                if (elTotalTrep) elTotalTrep.innerText = granTotalTrep.toLocaleString();
                if (elTotalEsc) elTotalEsc.innerText = granTotalEsc.toLocaleString();

            }

            // 4. Global Summary (Presidente/Alcalde) - Different IDs
            const presTotalTrep = document.getElementById('summary-trep-total');
            const presTotalEsc = document.getElementById('summary-esc-total');

            if (presTotalTrep || presTotalEsc) {
                const getPresVal = (key, source) => {
                    const el = document.querySelector(`tr[data-key="${key}"] input[data-source="${source}"]`);
                    return el ? (parseInt(el.value) || 0) : 0;
                };

                const pBlancosTrep = getPresVal('votos_blancos', 'TREP');
                const pNulosTrep = getPresVal('votos_nulos', 'TREP');
                const pBlancosEsc = getPresVal('votos_blancos', 'OFICIAL');
                const pNulosEsc = getPresVal('votos_nulos', 'OFICIAL');

                const gtTrep = totalTrep + pBlancosTrep + pNulosTrep;
                const gtEsc = totalEsc + pBlancosEsc + pNulosEsc;

                if (presTotalTrep) presTotalTrep.innerText = gtTrep.toLocaleString();
                if (presTotalEsc) presTotalEsc.innerText = gtEsc.toLocaleString();

                // Update Diff for Grand Total (Presidente)
                // Update Diff for Grand Total (Presidente)
                const grandTotalRow = document.querySelector('tr[data-key="gran_total"]');
                if (grandTotalRow) {
                    const diffCell = grandTotalRow.querySelector('.diff-cell');
                    if (diffCell) {
                        const d = gtEsc - gtTrep;
                        diffCell.innerText = d > 0 ? '+' + d : d;
                        diffCell.className = 'px-3 py-2 text-center text-xs diff-cell font-bold ' + (d === 0 ? 'text-gray-400' : 'text-red-500');
                    }
                }

                // Also Update Blancos / Nulos Diffs in Realtime
                ['votos_blancos', 'votos_nulos'].forEach(key => {
                    const row = document.querySelector(`tr[data-key="${key}"]`);
                    if (row) {
                        const diffCell = row.querySelector('.diff-cell');
                        const t = getPresVal(key, 'TREP');
                        const e = getPresVal(key, 'OFICIAL');
                        const d = e - t;
                        if (diffCell) {
                            diffCell.innerText = d > 0 ? '+' + d : d;
                            diffCell.className = 'px-3 py-2 text-center text-xs diff-cell font-bold ' + (d === 0 ? 'text-gray-400' : 'text-red-500');
                        }
                    }
                });
            }
        }

        function markDirty() {
            hasUnsavedChanges = true;
            const s = document.getElementById('save-status');
            if (s) {
                s.innerText = "⚠️ Guardar Cambios";
                s.classList.remove('text-slate-500', 'italic');
                s.classList.add('text-yellow-500', 'font-bold', 'animate-pulse');
            }
            updateCalculations();
        }

        function moveFocus(e, el) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const all = Array.from(document.querySelectorAll('.editable'));
                const i = all.indexOf(el);
                if (i > -1 && i < all.length - 1) {
                    all[i + 1].focus();
                    if (document.execCommand) document.execCommand('selectAll', false, null);
                } else el.blur();
            }
        }

        async function updateValue(key, source, value, isResumen = false) {
            markDirty();

            // Normalize Source
            const normSource = (source === 'ESCRUTINIO' || source === 'OFICIAL' || source === 'CNE') ? 'OFICIAL' : 'TREP';

            // Auto Save Logic
            let targetId = (normSource === 'OFICIAL') ? ID_ESC : ID_TREP;

            // Handle creating Official if missing
            if (!targetId && normSource === 'OFICIAL') targetId = 0;

            if (!targetId && normSource !== 'OFICIAL') return;

            let action = isResumen ? 'update_resumen' : 'update_vote';
            let val = parseInt(value) || 0;

            try {
                // Show mini saving indicator?
                const s = document.getElementById('save-status');
                if (s) { s.innerText = "Guardando..."; s.classList.add('text-blue-500'); }

                await fetch('/api/update_results', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action,
                        id_acta: targetId,
                        key: key,
                        votos: val,
                        jrv: '{{ jrv }}',
                        level: '{{ level }}',
                        source: source
                    })
                });

                // If successful, maybe update ID_ESC if we just created it?
                // But honestly, reload is better or just assume it exists now.
                // We won't get the new ID back easily to update const ID_ESC without reload.
                // But for subsequent edits, passing 0 is fine as get_or_create will find it.

                if (s) {
                    s.innerText = "Guardado";
                    s.classList.remove('text-blue-500', 'text-yellow-500', 'animate-pulse');
                    s.classList.add('text-green-500');
                    setTimeout(() => {
                        s.innerText = "Todo guardado";
                        s.classList.remove('text-green-500');
                        s.classList.add('text-slate-500', 'italic');
                        hasUnsavedChanges = false;
                    }, 1000);
                }
            } catch (e) {
                console.error("Auto save failed", e);
                const s = document.getElementById('save-status');
                if (s) { s.innerText = "Error al guardar"; s.classList.add('text-red-500'); }
            }
        }

        function hasChanges() { return hasUnsavedChanges; }

        // Transform State Management
        function getTransformState(img) {
            return {
                scale: parseFloat(img.dataset.scale) || 1,
                rotate: parseInt(img.dataset.rotate) || 0,
                panX: parseFloat(img.dataset.panX) || 0,
                panY: parseFloat(img.dataset.panY) || 0
            };
        }

        function updateTransform(img, state) {
            img.dataset.scale = state.scale;
            img.dataset.rotate = state.rotate;
            img.dataset.panX = state.panX;
            img.dataset.panY = state.panY;
            img.style.transform = `translate(${state.panX}px, ${state.panY}px) rotate(${state.rotate}deg) scale(${state.scale})`;
            // Always show grab cursor to indicate panning is possible, unless actively grabbing
            img.style.cursor = 'grab';
        }

        function changeZoom(id, delta) {
            const img = document.getElementById(id);
            if (img) {
                const s = getTransformState(img);
                const newScale = Math.min(Math.max(0.5, s.scale + delta), 5);
                s.scale = newScale;
                updateTransform(img, s);
            }
        }

        function rotate(id, deg) {
            const img = document.getElementById(id);
            if (!img) return;
            const s = getTransformState(img);
            s.rotate += deg;
            updateTransform(img, s);
        }

        function applyZoom(id, val) {
            const img = document.getElementById(id);
            if (img) {
                const s = getTransformState(img);
                s.scale = Math.min(Math.max(0.5, val), 5);
                updateTransform(img, s);
            }
        }

        function resetZoom(id) {
            const img = document.getElementById(id);
            if (img) {
                updateTransform(img, { scale: 1, rotate: 0, panX: 0, panY: 0 });
            }
        }

        // Pan / Drag Implementation
        function setupDraggable(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let isDragging = false;
            let startX, startY;
            let initialPanX, initialPanY;

            container.addEventListener('mousedown', e => {
                const img = container.querySelector('img');
                if (!img) return;
                const s = getTransformState(img);
                // Removed scale check to allow panning even at 1x if image is larger than container
                // if (s.scale <= 1) return; 

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialPanX = s.panX;
                initialPanY = s.panY;
                container.style.cursor = 'grabbing';
                img.style.cursor = 'grabbing';
                e.preventDefault();
            });

            window.addEventListener('mousemove', e => {
                if (!isDragging) return;
                const img = container.querySelector('img');
                if (!img) return;

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                const s = getTransformState(img);
                s.panX = initialPanX + dx;
                s.panY = initialPanY + dy;
                updateTransform(img, s);
            });

            window.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    container.style.cursor = 'default';
                    const img = container.querySelector('img');
                    if (img) img.style.cursor = 'grab';
                }
            });
        }

        // Initialize Drag for both viewers
        document.addEventListener('DOMContentLoaded', () => {
            try { updateCalculations(); } catch (e) { console.error("Error updating calculations:", e); }
            try { setupDraggable('viewer-trep'); } catch (e) { console.error("Error setupDraggable trep:", e); }
            try { setupDraggable('viewer-esc'); } catch (e) { console.error("Error setupDraggable esc:", e); }
        });



        async function saveRotation(source) {
            const imgId = source === 'TREP' ? 'img-trep' : 'img-esc';
            const actaId = source === 'TREP' ? ID_TREP : ID_ESC;

            const img = document.getElementById(imgId);
            if (!img || !actaId) {
                alert("No se puede guardar: Imagen o ID no encontrados.");
                return;
            }

            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i>';

            const s = getTransformState(img);
            try {
                const response = await fetch('/api/update_results', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'update_rotation', id_acta: actaId, rotation: s.rotate })
                });
                const data = await response.json();

                if (data.success) {
                    // Success feedback
                    btn.innerHTML = '<i class="ph ph-check text-green-500"></i>';
                    setTimeout(() => btn.innerHTML = originalHtml, 2000);
                } else {
                    alert("Error al guardar rotación.");
                    btn.innerHTML = originalHtml;
                }
            } catch (e) {
                console.error("Error saving rotation:", e);
                alert("Error de conexión.");
                btn.innerHTML = originalHtml;
            }
        }

        async function commitSave(silent = false) {
            if (!ID_TREP && !ID_ESC) return;

            // Save Rotation for Official Image
            const imgEsc = document.getElementById('img-esc');
            if (imgEsc && ID_ESC) {
                const s = getTransformState(imgEsc);
                try {
                    await fetch('/api/update_results', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'update_rotation', id_acta: ID_ESC, rotation: s.rotate })
                    });
                } catch (e) {
                    console.error("Error saving rotation (ESC):", e);
                }
            }

            // Save Rotation for FRENAEL Image
            const imgTrep = document.getElementById('img-trep');
            console.log("Saving TREP Rotation. Element:", imgTrep, "ID:", ID_TREP);
            if (imgTrep && ID_TREP) {
                const s = getTransformState(imgTrep);
                console.log("TREP Transform State:", s);
                try {
                    await fetch('/api/update_results', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'update_rotation', id_acta: ID_TREP, rotation: s.rotate })
                    });
                    console.log("TREP Rotation Sent");
                } catch (e) {
                    console.error("Error saving rotation (TREP):", e);
                }
            }

            const edits = [];
            document.querySelectorAll('.editable').forEach(el => {
                let val = parseInt(el.value) || 0;
                // data-source default to TREP (legacy compatibility)
                let source = el.dataset.source || 'TREP';
                edits.push({
                    type: el.dataset.type,
                    key: el.dataset.key,
                    votos: val,
                    source: source
                });
            });

            for (const item of edits) {
                let action = (item.type === 'special' || item.type === 'resumen') ? 'update_resumen' : 'update_vote';

                // Normalize Source for Save
                let normSource = (item.source === 'ESCRUTINIO' || item.source === 'OFICIAL' || item.source === 'CNE') ? 'OFICIAL' : 'TREP';

                let targetId = (normSource === 'OFICIAL') ? ID_ESC : ID_TREP;

                // Create Official Acta if missing (ID=0), but skip if TREP is missing (should verify TREP existence too?)
                // Actually, just pass 0 if Official, let backend handle creation.
                // Only skip if TREP ID is missing and source is TREP
                if (!targetId && normSource !== 'OFICIAL') continue;

                // If targetId is null/undefined/0 for Official, pass 0 so backend sees it.
                if (!targetId && normSource === 'OFICIAL') targetId = 0;

                await fetch('/api/update_results', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action,
                        id_acta: targetId,
                        key: item.key,
                        votos: item.votos,
                        jrv: '{{ jrv }}',
                        level: '{{ level }}',
                        source: normSource
                    })
                });
            }
            hasUnsavedChanges = false;
            if (!silent) {
                const s = document.getElementById('save-status');
                if (s) {
                    s.innerText = "Todo guardado";
                    s.classList.add('text-slate-500', 'italic');
                    s.classList.remove('text-yellow-500', 'font-bold', 'animate-pulse');
                }
            }
        }

        async function saveChangesUI() {
            const btn = document.getElementById('btn-save');
            if (!btn) return;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Guardando...';
            btn.disabled = true;
            try {
                await commitSave();
                btn.innerHTML = '<i class="ph ph-check"></i> GUARDADO';
                btn.classList.replace('bg-indigo-600', 'bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-green-600', 'bg-indigo-600');
                    btn.disabled = false;
                }, 1000);
            } catch (e) { alert("Error al guardar"); btn.disabled = false; btn.innerHTML = originalText; }
        }

        async function validateAndNext() {
            if (hasUnsavedChanges) {
                if (confirm("Tienes cambios sin guardar. ¿Guardar antes de continuar?")) {
                    await commitSave(true);
                } else return;
            }
            const btn = document.getElementById('btn-validate');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> ...'; }

            try {
                const res = await fetch('/api/validate_jrv', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jrv: '{{ jrv }}', level: '{{ level }}' })
                });
                const json = await res.json();
                if (json.success) {
                    if (json.next_jrv) window.location.href = "/comparison/" + json.next_jrv + "?level={{ level }}";
                    else window.location.href = "/";
                } else {
                    alert("Error: " + json.message);
                    if (btn) { btn.disabled = false; btn.innerHTML = 'VALIDAR Y SIGUIENTE <i class="ph ph-arrow-right text-lg"></i>'; }
                }
            } catch (e) { alert("Connection Error"); if (btn) btn.disabled = false; }
        }

        // Mouse Wheel Zoom
        document.querySelectorAll('.image-viewer').forEach(c => {
            c.addEventListener('wheel', e => {
                e.preventDefault(); // Prevent page scroll
                const img = c.querySelector('img');
                if (img) {
                    // Adjust sensitivity: -0.001 might be too slow or fast depending on the mouse
                    // Standard deltaY is usually around 100 per notch.
                    const delta = e.deltaY * -0.001;
                    changeZoom(img.id, delta);
                }
            }, { passive: false });
        });

        // Enter Key Navigation for Inputs
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                const target = e.target;
                if (target.tagName === 'INPUT' && target.type === 'number') {
                    e.preventDefault();

                    // Find all number inputs
                    const inputs = Array.from(document.querySelectorAll('input[type="number"]'));
                    const index = inputs.indexOf(target);

                    // Logic to find the "input below"
                    // The inputs are rendered row by row. 
                    // Layout: [Row 1 Col A] [Row 1 Col B] ... [Row 1 Col N]
                    //         [Row 2 Col A] [Row 2 Col B] ... 

                    // For Diputados Matrix:
                    // It's a table. Rows are 'tr'. 
                    // Inside 'tr', we have multiple 'td's. 
                    // Inside 'td', we have 2 inputs (FRENAEL and OFICIAL) side-by-side.

                    // If I am in Row X, Col Y, Input Side (Left/Right)
                    // I want to go to Row X+1, Col Y, Input Side (Left/Right)

                    // Simpler approach: 
                    // 1. Get current row and input index within row? 
                    // 2. Or, since the DOM order is: Row 1 (all cells), Row 2 (all cells).
                    // If we want to go "Down", we need to skip the other cells in the current row.

                    // Let's rely on the grid structure.
                    // Identify the column index of the parent TD and whether it's the 1st or 2nd input in that TD.

                    const cell = target.closest('td');
                    const row = target.closest('tr');

                    if (cell && row) {
                        const cellIndex = Array.from(row.children).indexOf(cell);
                        const inputIndexInCell = Array.from(cell.querySelectorAll('input')).indexOf(target);

                        const nextRow = row.nextElementSibling;
                        if (nextRow) {
                            const nextCell = nextRow.children[cellIndex];
                            if (nextCell) {
                                const nextInputs = nextCell.querySelectorAll('input');
                                if (nextInputs.length > inputIndexInCell) {
                                    nextInputs[inputIndexInCell].focus();
                                    nextInputs[inputIndexInCell].select();
                                    return;
                                }
                            }
                        }
                    }

                    // Fallback: just go to next input in DOM order (Tab-like behavior) if "down" logic fails or end of column?
                    // User asked "move to the casilla de abajo" (cell below).
                    // If at bottom, maybe do nothing or go to next column top? 
                    // Sticking to "cell below" logic above.
                }
            }
        });

        // Bulk Copy Logic
        function copyAll(fromSource, toSource) {
            if (!confirm(`¿Estás seguro de copiar todos los valores de ${fromSource} a ${toSource}? Esto sobrescribirá los datos actuales en pantalla.`)) return;

            // Normalize for selectors (TREP, OFICIAL)
            // In Deputies Matrix, OFICIAL is labeled "OFICIAL" in data-source.
            // But fromSource argument might be 'TREP' or 'OFICIAL'

            const inputs = document.querySelectorAll('input.editable');
            let count = 0;

            inputs.forEach(input => {
                // We are looking for the DESTINATION input
                // Check if this input matches the 'toSource' (using strict check or normalized)
                let inputSource = input.dataset.source;
                // data-source is 'TREP' or 'OFICIAL' or 'ESCRUTINIO'

                // Normalize Input Source
                let normInputSource = (inputSource === 'ESCRUTINIO' || inputSource === 'OFICIAL' || inputSource === 'CNE') ? 'OFICIAL' : 'TREP';

                if (normInputSource === toSource) {
                    // This is a destination input. Find its twin.
                    // Twin is in same container? 
                    // Matrix: They are in same 'tr' -> 'td'? No, different TDs?
                    // Let's see HTML structure.
                    // Matrix: Each TD has BOTH inputs.
                    // List: Each TR has BOTH inputs.

                    const parent = input.parentElement.parentElement; // div -> div -> td/tr?
                    // Structure: td > div (flex) > div (flex-1) > input
                    // So twin is in parent.querySelector(...)

                    // Actually, let's look for the sibling based on data-key
                    const key = input.dataset.key;
                    const type = input.dataset.type;

                    // Find the Source Input with same key/type but fromSource
                    // We need to be careful about matching exact key

                    // Scope search to the same row to be safe? Or global?
                    // Global is easier if keys are unique (which they ARE for votes).
                    // Resume keys are unique too.

                    // Note: querySelectorAll might be slow inside loop.
                    // Better: construct map first? Or just search document.
                    // Since it's a user triggered action, a little delay is ok.

                    // Try to find source input
                    // We need to match data-source that resolves to fromSource

                    // Construct selector for source
                    const sourceSelector = `input[data-key="${key}"][data-type="${type}"]`;
                    const candidates = document.querySelectorAll(sourceSelector);

                    let sourceInput = null;
                    candidates.forEach(cand => {
                        let s = cand.dataset.source;
                        let n = (s === 'ESCRUTINIO' || s === 'OFICIAL' || s === 'CNE') ? 'OFICIAL' : 'TREP';
                        if (n === fromSource) sourceInput = cand;
                    });

                    if (sourceInput) {
                        input.value = sourceInput.value;
                        count++;
                    }
                }
            });

            if (count > 0) {
                markDirty();
                alert(`Se copiaron ${count} registros. Recuerda GUARDAR para aplicar los cambios.`);
            } else {
                alert("No se encontraron registros coincidentes para copiar.");
            }
        }

        // Manual Upload & Delete Logic
        function triggerUpload(source) {
            const inputId = source === 'TREP' ? 'file-trep' : 'file-esc';
            document.getElementById(inputId).click();
        }

        async function uploadActa(source) {
            const inputId = source === 'TREP' ? 'file-trep' : 'file-esc';
            const fileInput = document.getElementById(inputId);
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('jrv', '{{ jrv }}');
            formData.append('nivel', '{{ level }}');
            formData.append('source', source);
            formData.append('file', file);

            try {
                // Show loading indicator?
                const res = await fetch('/api/upload_acta', { method: 'POST', body: formData });
                const json = await res.json();
                if (json.success) {
                    window.location.reload();
                } else {
                    alert('Error subiendo acta: ' + json.message);
                }
            } catch (e) { alert("Error de conexión"); }
        }

        async function deleteActa(source) {
            if (!confirm(`¿Estás seguro de ELIMINAR el acta de ${source}? Esta acción forzará los valores a CERO.`)) return;

            try {
                const res = await fetch('/api/delete_acta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jrv: '{{ jrv }}', nivel: '{{ level }}', source: source })
                });
                const json = await res.json();
                if (json.success) {
                    window.location.reload();
                } else {
                    alert('Error eliminando acta: ' + json.message);
                }
            } catch (e) { alert("Error de conexión"); }
        }

    </script>
</body>

</html>